<!DOCTYPE html>
<html>
<head>
  <title>Fraud Dashboard  </title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="sidebar">
  <h2>FraudSys</h2>
  <ul>
    <li class="active">Dashboard</li>
    <li onclick="logout()">Logout</li>
  </ul>
</div>

<div class="main">

  <div class="topbar">
    <h2>Dashboard</h2>
    <h3 id="roleText"></h3>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card">Total <span>0</span></div>
    <div class="card">Low <span>0</span></div>
    <div class="card">Medium <span>0</span></div>
    <div class="card">High <span>0</span></div>
  </div>

  <!-- CHARTS -->
  <div class="charts">
    <canvas id="lineChart"></canvas>
    <canvas id="pieChart"></canvas>
  </div>

  <!-- UPLOAD -->
  <input type="file" id="file">
  <button onclick="upload()">Upload</button>

  <!-- TABLE -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>Amount</th>
        <th>Claims</th>
        <th>Risk</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script>
const role = localStorage.getItem("role") || "admin";
document.getElementById("roleText").innerText = "Role: " + role;

function logout(){
  localStorage.removeItem("role");
  window.location.href = "login.html";
}

// GLOBAL CHARTS
let pieChart;

window.onload = function(){

  pieChart = new Chart(document.getElementById("pieChart"), {
    type: 'pie',
    data: {
      labels: ["Low","Medium","High"],
      datasets: [{
        data: [0,0,0],
        backgroundColor: ["green","orange","red"]
      }]
    }
  });

  lineChart = new Chart(document.getElementById("lineChart"), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Amount",
        data: [],
        borderColor: "green"
      }]
    }
  });
};

// UPLOAD FUNCTION
async function upload(){
  let file = document.getElementById("file").files[0];

  if(!file){
    alert("Select file first");
    return;
  }

  let formData = new FormData();
  formData.append("file", file);

  let res = await fetch("http://localhost:3000/upload", {
    method: "POST",
    body: formData
  });

  let data = await res.json();

  // COUNT
  let low=0, mid=0, high=0;

  data.forEach(item => {
    if(item.risk==="Low") low++;
    else if(item.risk==="Medium") mid++;
    else high++;
  });

  // UPDATE CARDS
  document.querySelectorAll(".card span")[0].innerText = data.length;
  document.querySelectorAll(".card span")[1].innerText = low;
  document.querySelectorAll(".card span")[2].innerText = mid;
  document.querySelectorAll(".card span")[3].innerText = high;

  // UPDATE PIE
  pieChart.data.datasets[0].data = [low, mid, high];
  pieChart.update();

  // UPDATE LINE
  lineChart.data.labels = data.map((_, i) => "C"+(i+1));
  lineChart.data.datasets[0].data = data.map(d => d.amount);
  lineChart.update();

  // TABLE
  let table = document.querySelector("#dataTable tbody");
  table.innerHTML = "";

  data.forEach(item => {
    table.innerHTML += `
      <tr>
        <td>${item.amount}</td>
        <td>${item.claims}</td>
        <td style="color:${item.risk==="High"?"red":item.risk==="Medium"?"orange":"green"}">
          ${item.risk}
        </td>
      </tr>`;
  });

  // ALERT
  if(high > 0){
    alert("⚠️ High Risk Claims Detected!");
  }

  document.getElementById("roleText").innerText = "Analysis Updated ✅";
}
</script>

</body>
</html>
