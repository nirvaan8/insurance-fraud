<!DOCTYPE html>
<html>
<head>
  <title>Fraud Intelligence Dashboard</title>

  <!-- CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="dashboard">

  <!-- ðŸ”¥ SIDEBAR -->
  <div class="sidebar">
    <h2><i class="fa-solid fa-shield-halved"></i> FraudSys</h2>

    <ul>
      <li class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</li>
      <li><i class="fa-solid fa-file"></i> Reports</li>
    </ul>

    <p id="roleDisplay"></p>

    <button onclick="toggleTheme()">
      <i class="fa-solid fa-moon"></i> Theme
    </button>

    <button onclick="logout()">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </div>

  <!-- ðŸ”¥ MAIN -->
  <div class="main">

    <h1>âš¡ Fraud Intelligence Dashboard</h1>

    <!-- Upload -->
    <div class="card">
      <input type="file" id="fileInput" />
      <button onclick="upload()">
        <i class="fa-solid fa-upload"></i> Upload CSV
      </button>

      <!-- Loader -->
      <div id="loader" class="loader" style="display:none;"></div>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat high">High <span id="highCount">0</span></div>
      <div class="stat medium">Medium <span id="mediumCount">0</span></div>
      <div class="stat low">Low <span id="lowCount">0</span></div>
    </div>

    <!-- Chart -->
    <canvas id="chart"></canvas>

    <!-- Download -->
    <button onclick="downloadData()">
      <i class="fa-solid fa-download"></i> Download Report
    </button>

    <!-- Table -->
    <table id="resultTable">
      <thead>
        <tr>
          <th>Fraud Score</th>
          <th>Risk Level</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

</div>

<!-- Toast -->
<div id="toast" class="toast">Uploaded Successfully ðŸš€</div>

<script>
const role = localStorage.getItem("role");

if (!role) {
  window.location.href = "login.html";
}

document.getElementById("roleDisplay").innerText = "Role: " + role;

function logout() {
  localStorage.removeItem("role");
  window.location.href = "login.html";
}

function toggleTheme() {
  document.body.classList.toggle("light");
}

function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 2000);
}

function downloadData() {
  const table = document.getElementById("resultTable").outerHTML;
  const blob = new Blob([table], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "fraud_report.html";
  a.click();
}

let chart;

async function upload() {
  if (role !== "admin") {
    alert("Only admin can upload files");
    return;
  }

  const file = document.getElementById("fileInput").files[0];

  if (!file) {
    alert("Select a file");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  document.getElementById("loader").style.display = "block";

  const res = await fetch("http://localhost:5000/api/upload", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  document.getElementById("loader").style.display = "none";

  showToast("Upload successful ðŸš€");

  const tableBody = document.querySelector("#resultTable tbody");
  tableBody.innerHTML = "";

  let high = 0, medium = 0, low = 0;

  data.forEach(item => {
    const risk = item.RiskLevel.toLowerCase();

    if (risk === "high") high++;
    else if (risk === "medium") medium++;
    else low++;

    const row = `<tr>
      <td>${item.FraudScore}</td>
      <td>${item.RiskLevel}</td>
    </tr>`;

    tableBody.innerHTML += row;
  });

  document.getElementById("highCount").innerText = high;
  document.getElementById("mediumCount").innerText = medium;
  document.getElementById("lowCount").innerText = low;

  const ctx = document.getElementById("chart").getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["High", "Medium", "Low"],
      datasets: [{
        data: [high, medium, low],
        backgroundColor: ["#ff4d4d", "#ffd633", "#66ff99"]
      }]
    }
  });
}
</script>

</body>
</html>